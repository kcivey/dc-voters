(function(a){if(typeof define==="function"&&define.amd){define(["underscore","jquery","backbone"],a)}else{a(_,$,Backbone)}}(function(a,b,c){if(!c){throw"Please include Backbone.js before Backbone.ModelBinder.js"}c.ModelBinder=function(d){a.bindAll(this);this._modelSetOptions=d||{}};c.ModelBinder.VERSION="0.1.5";c.ModelBinder.Constants={};c.ModelBinder.Constants.ModelToView="ModelToView";c.ModelBinder.Constants.ViewToModel="ViewToModel";a.extend(c.ModelBinder.prototype,{bind:function(e,f,g,d){this.unbind();this._model=e;this._rootEl=f;this._modelSetOptions=a.extend({},this._modelSetOptions,d);if(!this._model){throw"model must be specified"}if(!this._rootEl){throw"rootEl must be specified"}if(g){this._attributeBindings=b.extend(true,{},g);this._initializeAttributeBindings();this._initializeElBindings()}else{this._initializeDefaultBindings()}this._bindModelToView();this._bindViewToModel()},unbind:function(){this._unbindModelToView();this._unbindViewToModel();if(this._attributeBindings){delete this._attributeBindings;this._attributeBindings=undefined}},_initializeAttributeBindings:function(){var f,e,g,d,h;for(f in this._attributeBindings){e=this._attributeBindings[f];if(a.isString(e)){g={elementBindings:[{selector:e}]}}else{if(a.isArray(e)){g={elementBindings:e}}else{if(a.isObject(e)){g={elementBindings:[e]}}else{throw"Unsupported type passed to Model Binder "+g}}}for(d=0;d<g.elementBindings.length;d++){h=g.elementBindings[d];h.attributeBinding=g}g.attributeName=f;this._attributeBindings[f]=g}},_initializeDefaultBindings:function(){var f,d,h,e;this._attributeBindings={};d=b("[name]",this._rootEl);for(f=0;f<d.length;f++){h=d[f];e=b(h).attr("name");if(!this._attributeBindings[e]){var g={attributeName:e};g.elementBindings=[{attributeBinding:g,boundEls:[h]}];this._attributeBindings[e]=g}else{this._attributeBindings[e].elementBindings.push({attributeBinding:this._attributeBindings[e],boundEls:[h]})}}},_initializeElBindings:function(){var d,h,j,i,e,g,f;for(d in this._attributeBindings){h=this._attributeBindings[d];for(j=0;j<h.elementBindings.length;j++){i=h.elementBindings[j];if(i.selector===""){e=b(this._rootEl)}else{e=b(i.selector,this._rootEl)}if(e.length===0){throw"Bad binding found. No elements returned for binding selector "+i.selector}else{i.boundEls=[];for(g=0;g<e.length;g++){f=e[g];i.boundEls.push(f)}}}}},_bindModelToView:function(){this._model.on("change",this._onModelChange,this);this.copyModelAttributesToView()},copyModelAttributesToView:function(d){var e,f;for(e in this._attributeBindings){if(d===undefined||a.indexOf(d,e)!==-1){f=this._attributeBindings[e];this._copyModelToView(f)}}},_unbindModelToView:function(){if(this._model){this._model.off("change",this._onModelChange);this._model=undefined}},_bindViewToModel:function(){b(this._rootEl).delegate("","change input",this._onElChanged);b(this._rootEl).delegate("[contenteditable]","blur",this._onElChanged)},_unbindViewToModel:function(){if(this._rootEl){b(this._rootEl).undelegate("","change input",this._onElChanged);b(this._rootEl).undelegate("[contenteditable]","blur",this._onElChanged)}},_onElChanged:function(e){var d,h,g,f;d=b(e.target)[0];h=this._getElBindings(d);for(g=0;g<h.length;g++){f=h[g];if(this._isBindingUserEditable(f)){this._copyViewToModel(f,d)}}},_isBindingUserEditable:function(d){return d.elAttribute===undefined||d.elAttribute==="text"||d.elAttribute==="html"},_getElBindings:function(g){var e,h,d,k,j,f;var i=[];for(e in this._attributeBindings){h=this._attributeBindings[e];for(d=0;d<h.elementBindings.length;d++){k=h.elementBindings[d];for(j=0;j<k.boundEls.length;j++){f=k.boundEls[j];if(f===g){i.push(k)}}}}return i},_onModelChange:function(){var e,d;for(e in this._model.changedAttributes()){d=this._attributeBindings[e];if(d){this._copyModelToView(d)}}},_copyModelToView:function(g){var d,j,i,f;var h=this._model.get(g.attributeName);for(d=0;d<g.elementBindings.length;d++){j=g.elementBindings[d];if(!j.isSetting){var e=this._getConvertedValue(c.ModelBinder.Constants.ModelToView,j,h);for(i=0;i<j.boundEls.length;i++){f=j.boundEls[i];this._setEl(b(f),j,e)}}}},_setEl:function(e,f,d){if(f.elAttribute){this._setElAttribute(e,f,d)}else{this._setElValue(e,d)}},_setElAttribute:function(f,g,e){switch(g.elAttribute){case"html":f.html(e);break;case"text":f.text(e);break;case"enabled":f.attr("disabled",!e);break;case"displayed":f[e?"show":"hide"]();break;case"hidden":f[e?"hide":"show"]();break;case"css":f.css(g.cssAttribute,e);break;case"class":var d=this._model.previous(g.attributeBinding.attributeName);if(!a.isUndefined(d)){d=this._getConvertedValue(c.ModelBinder.Constants.ModelToView,g,d);f.removeClass(d)}if(e){f.addClass(e)}break;default:f.attr(g.elAttribute,e)}},_setElValue:function(e,d){if(e.attr("type")){switch(e.attr("type")){case"radio":if(e.val()===d){e.attr("checked","checked")}break;case"checkbox":if(d){e.attr("checked","checked")}else{e.removeAttr("checked")}break;default:e.val(d)}}else{if(e.is("input")||e.is("select")||e.is("textarea")){e.val(d)}else{e.text(d)}}},_copyViewToModel:function(e,d){if(!e.isSetting){e.isSetting=true;this._setModel(e,b(d));if(e.converter){this._copyModelToView(e.attributeBinding)}e.isSetting=false}},_getElValue:function(e,d){switch(d.attr("type")){case"checkbox":return d.prop("checked")?true:false;default:if(d.attr("contenteditable")!==undefined){return d.html()}else{return d.val()}}},_setModel:function(h,e){var g={};var d=this._getElValue(h,e);d=this._getConvertedValue(c.ModelBinder.Constants.ViewToModel,h,d);g[h.attributeBinding.attributeName]=d;var f=a.extend({},this._modelSetOptions,{changeSource:"ModelBinder"});this._model.set(g,f)},_getConvertedValue:function(e,f,d){if(f.converter){d=f.converter(e,d,f.attributeBinding.attributeName,this._model)}return d}});c.ModelBinder.CollectionConverter=function(d){this._collection=d;if(!this._collection){throw"Collection must be defined"}a.bindAll(this,"convert")};a.extend(c.ModelBinder.CollectionConverter.prototype,{convert:function(e,d){if(e===c.ModelBinder.Constants.ModelToView){return d?d.id:undefined}else{return this._collection.get(d)}}});c.ModelBinder.createDefaultBindings=function(m,g,h,f){var k,i,j,l;var e={};k=b("["+g+"]",m);for(i=0;i<k.length;i++){j=k[i];l=b(j).attr(g);if(!e[l]){var d={selector:"["+g+'="'+l+'"]'};e[l]=d;if(h){e[l].converter=h}if(f){e[l].elAttribute=f}}}return e};c.ModelBinder.combineBindings=function(d,e){a.each(e,function(g,f){var h={selector:g.selector};if(g.converter){h.converter=g.converter}if(g.elAttribute){h.elAttribute=g.elAttribute}if(!d[f]){d[f]=h}else{d[f]=[d[f],h]}})};return c.ModelBinder}));